services:
    workspace:
        build:
          context: .
          dockerfile: Dockerfile
        hostname: workspace
        security_opt:
          - seccomp:unconfined
        ports:
          - "8080:8080"
          - "8090:8090"
          - "9009:9009"
        environment:
          PGPASSWORD: test
          HOME: /home/dev
          MAVEN_OPTS: "-Dgpg.skip=true"
        user: 'dev'
        command: sleep infinity
        volumes:
          # Mounts the project folder to '/workspace'. The target path inside the container
          # should match what your application expects. In this case, the compose file is
          # in a sub-folder, so you will mount '..'. You would then reference this path as the
          # 'workspaceFolder' in '.devcontainer/devcontainer.json' so VS Code starts here.
          - ..:/home/dev/workspace/datashare:cached

    amqp:
      image: cloudamqp/lavinmq:2.6.8
      ports:
        - "5673:5672"
        - "15673:15672"
      healthcheck:
        test: [ "CMD", "/usr/bin/lavinmqctl", "status" ]
        interval: 2s
        timeout: 10s
        retries: 3
        start_period: 2s

    s3mock:
      image: adobe/s3mock:4.11.0
      ports:
        - "9090:9090"
      environment:
        COM_ADOBE_TESTING_S3MOCK_STORE_INITIAL_BUCKETS: testbucket
      healthcheck:
        test: [ "CMD_SHELL", "wget --quiet --tries=1 --spider http://localhost:9090/" ]
        interval: 5s
        timeout: 5s
        retries: 3
        start_period: 2s
      deploy:
        resources:
          limits:
            memory: 2048m
          reservations:
            memory: 512m

    redis:
        image: redis:7.0-alpine
        ports:
          - 6379:6379

    postgres:
      image: pgvector/pgvector:pg15
      environment:
        POSTGRES_USER: dstest
        POSTGRES_PASSWORD: test
        POSTGRES_DB: dstest
      volumes:
        - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
      ports:
        - "5432:5432"
      healthcheck:
        test: [ "CMD-SHELL", "pg_isready -U dstest" ]
        interval: 1s
        timeout: 5s
        retries: 60
        start_period: 30s

    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.17.7
        environment:
          - "ES_JAVA_OPTS=-Xms256m -Xmx256m"
          - discovery.type=single-node
          - cluster.name=datashare
          - cluster.routing.allocation.disk.watermark.low=90%
          - cluster.routing.allocation.disk.watermark.high=99%
          - cluster.routing.allocation.disk.watermark.flood_stage=100%
          - http.compression=false
          - http.cors.enabled=true
          - http.cors.allow-origin="*"
          - http.cors.allow-methods=OPTIONS, HEAD, GET, POST, PUT, DELETE
          - indices.query.bool.max_clause_count=20000
        ports:
          - "9200:9200"

    temporal:
      build:
        context: .
        target: temporal-test-container
      depends_on:
        temporal-setup-db:
          condition: service_completed_successfully
      ports:
        - "7233:7233"
        - "8233:8233"
        - "8076:8076"
      environment:
        - DB=postgres12
        - DB_PORT=5432
        - POSTGRES_USER=dstest
        - POSTGRES_PWD=test
        - POSTGRES_SEEDS=postgres
        - BIND_ON_IP=0.0.0.0
        - LOG_LEVEL=info
      healthcheck:
        test: [ "CMD", "nc", "-z", "0.0.0.0", "7233" ]
        interval: 2s
        timeout: 1s
        start_period: 1s
        retries: 10

    temporal-ui:
      image: temporalio/ui:2.45.3
      depends_on:
        temporal:
          condition: service_healthy
      environment:
        - TEMPORAL_ADDRESS=temporal:7233
        - TEMPORAL_CORS_ORIGINS=http://localhost:3000
      ports:
        - "8080:8080"

    temporal-setup-db:
      image: temporalio/admin-tools:1.29
      depends_on:
        postgres:
          condition: service_healthy
      container_name: temporal-setup-db
      restart: on-failure:5
      environment:
        - TEMPORAL_ADDRESS=temporal:7233
        - DEFAULT_NAMESPACE=default
      volumes:
        - ./temporal:/temporal
      entrypoint: [ "/bin/sh" ]
      command: /temporal/setup.sh

